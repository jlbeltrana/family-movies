rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Allowlist: documento config/allowedEmails con campo "emails" tipo map: { "email@ejemplo.com": true }
    function isAllowed() {
      let allowed = get(/databases/$(database)/documents/config/allowedEmails);
      return request.auth != null && request.auth.token.email in allowed.data.emails;
    }

    // Catálogo de películas: solo lectura para usuarios en la allowlist
    match /movies/{movieId} {
      allow read: if isAllowed();
      allow write: if false;
    }

    // Progreso por usuario: cada usuario solo lee/escribe su propia subcolección
    match /users/{uid}/progress/{movieId} {
      allow read, write: if request.auth != null && request.auth.uid == uid && isAllowed();
    }

    // Config (allowlist): cualquier usuario autenticado puede leer (necesario para verificar allowlist)
    match /config/{doc} {
      allow read: if request.auth != null;
      allow write: if false;
    }
  }
}
